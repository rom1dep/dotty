#!/usr/bin/env bash
#
# Usage: get-scala-commit-sha [dir]
# Figures out current commit sha of a git clone.
# If no dir is given, current working dir is used.
#
# Example build version string:
#   6f1c486d0ba
#

[[ $# -eq 0 ]] || cd "$1"

if [ -d .git ] || git rev-parse --is-inside-git-dir > /dev/null 2>&1 ; then
  # printf %016s is not portable for 0-padding, has to be a digit.
  # so we're stuck disassembling it.
  hash=$(git log -1 --format="%H" HEAD)
  hash=${hash#g}
  hash=${hash:0:10}
elif [ -d ".hg" ] || hg root > /dev/null ; then
  # this should work in any mercurial repository (with or without hg-git).
  # hg gexport makes sure we generate git hashes for all hg commits in case hg-git is used.
  # if no gitnode is returned, we simply pick the mercurial hash instead.
  hg gexport > /dev/null 2>&1
  hash=$(HGPLAIN= hg log -r . -T "{fill(gitnode,10)|firstline}" > /dev/null 2>&1)
  if [[ -z $hash ]] ; then hash=$(HGPLAIN= hg log -r . -T "{fill(node,10)|firstline}") ; fi
fi

echo "$hash"
